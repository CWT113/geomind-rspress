# 着色器

> 本节讲述 WebGL 的核心概念——着色器，学习顶点着色器和片元着色器的使用，深入理解二者是如何共同工作完成绘图的流程。



WebGL 着色器（Shader）是运行在 GPU 上的小程序，用于 <span class="marker-text-highlight"> 控制顶点的处理和像素的颜色渲染 </span>。

既然着色器运行在 GPU 上，因此我们需要编写能够在 GPU 上运行的代码，这样的代码需要提供成对的方法。每对方法中一个叫 <span class="marker-text-highlight"> 顶点着色器 </span>，另一个叫 <span class="marker-text-highlight"> 片元着色器 </span>，并且使用类似于 C 语言的强类型语言 GLSL 编写。



## 顶点着色器

顶点着色器（Vertex shader）是用来描述顶点特性（如位置、大小等）的程序。根据计算出的一系列顶点位置，WebGL 可以对点、线和三角形在内的图元进行光栅化处理。

每个顶点都调用一次顶点着色器，每次调用都设置一个特殊的全局变量 `gl_Position`，该变量的值就是用于裁剪空间的坐标值。

> [!NOTE] 顶点着色器设置数据的方式 
>
> 1. 顶点着色器源码直接赋值
> 2. `Attributes` 属性（从缓冲中获取数据）
> 3. `Uniforms` 全局变量（在一次绘制中对所有顶点保持一致值）
> 4. `Textures` 纹理（从像素或纹理元素中获取的数据）

```html [源码直接赋值方式] {26-38}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>DrawPoint</title>
  </head>
  <body>
    <canvas id="example" width="400" height="400">
      请使用支持 canvas 的浏览器查看
    </canvas>

    <script>
      const canvas = document.getElementById("example");
      if (!canvas) {
        console.log("Failed to load canvas element.");
      }
      // 获取 webgl 绘图上下文
      const gl = canvas.getContext("webgl");

      // 设置清空背景颜色
      gl.clearColor(0, 0, 0, 1);
      // 清空 canvas 背景
      gl.clear(gl.COLOR_BUFFER_BIT);

      // 创建顶点着色器
      const VSHADER_SOURCE = `
        void main() {
          // 设置顶点坐标
          gl_Position = vec4(0.0, 0.0, 0.0, 1.0);
          // 设置点大小
          gl_PointSize = 10.0;
        }
      `;
      const vShader = gl.createShader(gl.VERTEX_SHADER);
      // 向顶点着色器中填充着色器程序源码
      gl.shaderSource(vShader, VSHADER_SOURCE);
      // 编译顶点着色器
      gl.compileShader(vShader);

      // 创建片段着色器
      const FSHADER_SOURCE = `
        void main() {
          // 设置颜色
          gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
        }
      `;
      const fShader = gl.createShader(gl.FRAGMENT_SHADER);
      // 向片元着色器中填充着色器程序源码
      gl.shaderSource(fShader, FSHADER_SOURCE);
      // 编译片元着色器
      gl.compileShader(fShader);

      // 创建程序对象
      const program = gl.createProgram();
      // 为程序对象分配着色器
      gl.attachShader(program, vShader);
      gl.attachShader(program, fShader);
      // 连接程序对象
      gl.linkProgram(program);
      // 使用程序对象
      gl.useProgram(program);

      // 绘制图形
      gl.drawArrays(gl.POINTS, 0, 1);
    </script>
  </body>
</html>
```

> [!CAUTION] 注意
>
> `gl_Position` 变量必须被赋值，否则着色器就无法正常工作。相反，`gl_PointSize` 并不是必须的，默认值为 1.0。



## 片元着色器

片元着色器（Fragment shader）用于逐片元处理过程（如光照、颜色等）的程序。

每个像素都调用一次片段着色器，每次调用需要从设置的全局变量 `gl_FragColor` 中获取颜色信息。

> [!NOTE] 片段着色器获取数据的方式
>
> 1. `Uniforms` 全局变量
> 2. `Textures` 纹理
> 3. `Varyings` 可变量











